<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cat√°logo Mayoreo | Tertulia Librer√≠a</title>

<style>
body{margin:0;font-family:Arial;background:#f4f7fb}
header{background:#0b5ed7;color:#fff;padding:12px;display:flex;gap:12px;align-items:center}
.menu-btn{font-size:22px;cursor:pointer}
.search{padding:10px;background:#e9eef8}
.search input{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc}

.menu{display:none;background:#fff;border-bottom:1px solid #ddd}
.menu div{padding:12px;border-bottom:1px solid #eee;cursor:pointer}
.menu div:hover{background:#f0f4ff}

.container{max-width:900px;margin:auto;padding:12px}

.product{
  background:#fff;border-radius:8px;padding:10px;
  display:flex;gap:10px;margin-bottom:10px;
  box-shadow:0 2px 6px rgba(0,0,0,.08)
}
.icon{width:60px;height:60px;background:#e3e9f5;border-radius:6px;
display:flex;align-items:center;justify-content:center;font-size:26px;cursor:pointer}
.info{flex:1}
.title{font-weight:bold}
.price{font-size:14px}
.ok{color:#2e7d32;font-weight:bold}
.no{color:#c62828;font-weight:bold}
.qty{display:flex;gap:6px;align-items:center}
.qty input{width:60px}

.cart-btn{
  position:fixed;bottom:20px;right:20px;
  background:#0b5ed7;color:#fff;
  padding:12px 16px;border-radius:40px;
  cursor:pointer;font-weight:bold
}

/* LOGIN */
#loginModal{
  position:fixed; inset:0;
  background:#0b5ed7;
  display:flex; align-items:center; justify-content:center;
  z-index:2000;
}

/* MODAL IMAGEN */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
align-items:center;justify-content:center;z-index:999}
.modal-content{
  background:#fff;padding:15px;border-radius:8px;
  width:90%;max-width:420px;
  max-height:90vh;overflow:auto;position:relative;
}
.modal-content img{
  width:100%;max-height:70vh;object-fit:contain
}
.close{
  position:sticky;top:0;
  background:#fff;font-weight:bold;
  cursor:pointer;padding-bottom:8px;
}

/* CARRITO */
.cart-panel{
  position:fixed;top:0;right:0;
  width:340px;height:100vh;
  background:#fff;
  box-shadow:-4px 0 10px rgba(0,0,0,.25);
  display:none;flex-direction:column;z-index:1000;
}
.cart-header{
  padding:15px;border-bottom:1px solid #ddd;
  display:flex;justify-content:space-between;font-weight:bold
}
.cart-body{padding:15px;flex:1;overflow-y:auto}
.cart-item{font-size:14px;margin-bottom:8px}
.cart-item button{border:none;background:none;color:red;cursor:pointer}
.cart-total{padding:15px;border-top:1px solid #ddd;background:#fafafa}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginModal">
  <div style="background:white;padding:20px;border-radius:10px;width:90%;max-width:360px">
    <h3>üîê Acceso Mayoristas</h3>
    <input id="loginUser" placeholder="Usuario" style="width:100%;padding:10px;margin-bottom:10px">
    <input id="loginPass" type="password" placeholder="Contrase√±a" style="width:100%;padding:10px;margin-bottom:10px">
    <button onclick="login()" style="width:100%;padding:12px;background:#0b5ed7;color:white;border:none;border-radius:6px;font-weight:bold">
      Entrar
    </button>
    <div id="loginMsg" style="margin-top:10px;font-weight:bold"></div>
  </div>
</div>

<header>
  <span class="menu-btn" onclick="toggleMenu()">‚ò∞</span>
  Cat√°logo Mayoreo ‚Äì Tertulia Librer√≠a
</header>

<div class="search">
  <input id="q" placeholder="Buscar..." oninput="render()">
</div>

<div id="menu" class="menu"></div>
<div class="container" id="lista"></div>

<div class="cart-btn" onclick="toggleCart()">üõí Carrito (<span id="cartCount">0</span>)</div>

<!-- MODAL IMAGEN -->
<div class="modal" id="imgModal">
  <div class="modal-content">
    <div class="close" onclick="closeImg()">‚úñ</div>
    <img id="img">
  </div>
</div>

<!-- CARRITO -->
<div class="cart-panel" id="cartPanel">
  <div class="cart-header">
    üõí Carrito
    <span onclick="toggleCart()" style="cursor:pointer">‚úñ</span>
  </div>
  <div class="cart-body" id="cartItems"></div>
  <div class="cart-total" id="cartTotal"></div>
</div>

<script>
// ================= CONFIG =================
const URL_JSON = "https://script.google.com/macros/s/AKfycby0I4zJSTM1bpWNB0QVpktidbyuXDzZFa1EjfZblZ0zwhkBrtAxYU45BQT88uHZhZYGPQ/exec";
const API_LOGIN = "https://script.google.com/macros/s/AKfycby-3qvGvNXqVEezNbFUBdVmNDHYMg6BFHan755_U4Rw21rhpg_7ENkBpVHsiJtqRPZF/exec";

// ================= ESTADO =================
let productos=[],categoria="TODOS";
let carrito=JSON.parse(localStorage.getItem("carrito")||"{}");
let NIVEL_CLIENTE = 0;

// ===== DESCUENTOS POR VOLUMEN =====
const DESCUENTOS_VOLUMEN = [
  { min: 3000, pct: 25 },
  { min: 2000, pct: 20 },
  { min: 1000, pct: 15 },
  { min: 500,  pct: 10 }
];

function obtenerDescuentoPorTotal(total){
  for(const d of DESCUENTOS_VOLUMEN){
    if(total >= d.min) return d.pct;
  }
  return 0;
}



function login(){
  const form = new URLSearchParams();
  form.append("accion","login");
  form.append("usuario", loginUser.value);
  form.append("password", loginPass.value);

  fetch(API_LOGIN,{
    method:"POST",
    body: form
  })
  .then(r => r.json())
  .then(res=>{
  if(res.ok){
    NIVEL_CLIENTE = parseInt(res.cliente.nivel) || 0;
    document.getElementById("loginModal").style.display = "none";
    render();
    updateCart();
  } else {
    loginMsg.textContent = "‚ùå " + res.error;
    loginMsg.style.color = "red";
  }
})
  .catch(err=>{
    console.error(err);
    loginMsg.textContent = "‚ùå Error de conexi√≥n";
    loginMsg.style.color = "red";
  });
}

// ================= DESCUENTO =================
function descuento(){
  return NIVEL_CLIENTE || 0;
}

// ================= PRODUCTOS =================
fetch(URL_JSON)
  .then(r => r.json())
  .then(d => {
    if (!d || !Array.isArray(d.libros)) {
      console.error("JSON inv√°lido:", d);
      alert("‚ùå Error cargando cat√°logo");
      return;
    }

    const noLibro = [
      "rompecabezas","juguetes","otros productos",
      "juegos de mesa","pistolas hidrogel","segunda mano"
    ];

    productos = d.libros.map(p => ({
      ...p,
      esLibro: !noLibro.includes(String(p.categoria || "").toLowerCase())
    }));

    menuCategorias();
    render();
    updateCart();
  })
  .catch(err => {
    console.error("Error cargando productos:", err);
    alert("‚ùå No se pudo cargar el cat√°logo");
  });

function toggleMenu(){
  menu.style.display = menu.style.display==="block"?"none":"block";
}

function menuCategorias(){
  menu.innerHTML="";
  ["TODOS","LIBROS"].forEach(c=>{
    const d=document.createElement("div");
    d.textContent=c;
    d.onclick=()=>{categoria=c;render();toggleMenu()};
    menu.appendChild(d);
  });
  [...new Set(productos.filter(p=>!p.esLibro).map(p=>p.categoria))].forEach(c=>{
    const d=document.createElement("div");
    d.textContent=c;
    d.onclick=()=>{categoria=c;render();toggleMenu()};
    menu.appendChild(d);
  });
}

function render(){
  const q=document.getElementById("q").value.toLowerCase();
  lista.innerHTML="";
  productos.filter(p=>{
    if(!String(p.titulo||"").toLowerCase().includes(q))return false;
    if(categoria==="TODOS")return true;
    if(categoria==="LIBROS")return p.esLibro;
    return p.categoria===categoria;
  }).forEach(p=>{
    const d=document.createElement("div");
    d.className="product";
    d.innerHTML=`
      <div class="icon" onclick="showImg('${p.imagen||""}')">üì¶</div>
      <div class="info">
        <div class="title">${p.titulo}</div>
        <div class="price">
          $${p.precio}
          ¬∑ <span class="${p.existencia>0?"ok":"no"}">
              ${p.existencia>0?"Disponible":"Agotado"}
            </span>
        </div>
      </div>
      <div class="qty">
        <input type="number"
          min="1"
          max="${p.existencia}"
          value="1"
          id="q_${p.code}"
          ${p.existencia<=1?"readonly":""}
        >
        <button
          onclick="add('${p.code}')"
          ${p.existencia<=0 ? "disabled style='opacity:.5;cursor:not-allowed'" : ""}
        >
          Agregar
        </button>
      </div>`;
    lista.appendChild(d);
  });
}
// ================= CARRITO =================
function add(code){
  const p = productos.find(x => String(x.code) === String(code));
  if (!p) return;

  const disponible = parseInt(p.existencia) || 0;
  if (disponible <= 0) {
    alert("‚ùå Producto agotado");
    return;
  }

  const input = document.getElementById("q_" + code);
  let qty = parseInt(input.value) || 1;

  const enCarrito = carrito[code] || 0;
  const maxPermitido = disponible - enCarrito;

  if (maxPermitido <= 0) {
    alert("‚ö†Ô∏è Ya agregaste el m√°ximo disponible");
    return;
  }

  if (qty > maxPermitido) {
    qty = maxPermitido;
    input.value = maxPermitido;
  }

  carrito[code] = enCarrito + qty;
  updateCart();
}

function removeItem(code){
  delete carrito[code];
  updateCart();
}

function updateCart(){
  localStorage.setItem("carrito",JSON.stringify(carrito));
  cartItems.innerHTML="";

  let subtotal = 0;

  Object.keys(carrito).forEach(c=>{
    const p = productos.find(x=>String(x.code)===String(c));
    const qty = carrito[c];
    const t = p.precio * qty;
    subtotal += t;

    cartItems.innerHTML += `
      <div class="cart-item">
        ${p.titulo}<br>
        ${qty} x $${p.precio} = $${t}
        <button onclick="removeItem('${c}')">‚ùå</button>
      </div>`;
  });

  const pctDesc = obtenerDescuentoPorTotal(subtotal);
  const montoDesc = Math.round(subtotal * pctDesc / 100);
  const total = subtotal - montoDesc;

  cartTotal.innerHTML = `
    Subtotal: $${subtotal}<br>
    Descuento: ${pctDesc}% (-$${montoDesc})<br>
    <b>Total: $${total}</b>
    ${subtotal > 0 ? `
      <br><br>
      <button onclick="generarPedido()" 
        style="width:100%;padding:12px;background:#198754;color:#fff;
        border:none;border-radius:6px;font-size:16px;font-weight:bold">
        üìÑ Generar pedido
      </button>
    ` : ""}
  `;

  cartCount.textContent = Object.values(carrito).reduce((a,b)=>a+b,0);
}

function toggleCart(){
  cartPanel.style.display=cartPanel.style.display==="flex"?"none":"flex";
}

// ================= IMAGEN =================
function showImg(u){ if(u){ img.src=u; imgModal.style.display="flex"; } }
function closeImg(){ imgModal.style.display="none"; }

function generarPedido(){
  const items = [];
  let subtotal = 0;

  Object.keys(carrito).forEach(c=>{
    const p = productos.find(x=>String(x.code)===String(c));
    const qty = carrito[c];
    const total = p.precio * qty;
    subtotal += total;

    items.push({
      titulo: p.titulo,
      cantidad: qty,
      precio: p.precio,
      total
    });
  });

  const pctDesc = obtenerDescuentoPorTotal(subtotal);
  const montoDesc = Math.round(subtotal * pctDesc / 100);
  const totalFinal = subtotal - montoDesc;

  generarPDF(items, subtotal, pctDesc, montoDesc, totalFinal);
  abrirWhatsApp(totalFinal);
}
function generarPDF(items, subtotal, pctDesc, montoDesc, totalFinal){
  const w = window.open("", "_blank");
  w.document.write(`
    <html><head><title>Pedido Mayorista</title></head>
    <body style="font-family:Arial">
      <h2>Tertulia Librer√≠a ‚Äì Pedido Mayorista</h2>
      <table border="1" cellpadding="6" cellspacing="0" width="100%">
        <tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Total</th></tr>
        ${items.map(i=>`
          <tr>
            <td>${i.titulo}</td>
            <td>${i.cantidad}</td>
            <td>$${i.precio}</td>
            <td>$${i.total}</td>
          </tr>
        `).join("")}
      </table>
      <p>Subtotal: $${subtotal}</p>
      <p>Descuento: ${pctDesc}% (-$${montoDesc})</p>
      <h3>Total: $${totalFinal}</h3>
      <script>window.print()<\/script>
    </body></html>
  `);
  w.document.close();
}
function abrirWhatsApp(total){
  const telefono = "524751070540"; // M√©xico: 52 + n√∫mero

  const mensaje = encodeURIComponent(
    `Hola üëã, acabo de generar un pedido mayorista.
Total del pedido: $${total}
Adjunto el PDF del pedido.`
  );

  window.open(`https://wa.me/${telefono}?text=${mensaje}`, "_blank");
}

</script>

</body>
</html>

